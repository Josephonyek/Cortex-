<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cortex Gold | Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script> 
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // 1. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAzXdmATMQ8bMAtCIMiruUr4o5lGLMTSco",
            authDomain: "cortex-gold-6c147.firebaseapp.com",
            databaseURL: "https://cortex-gold-6c147-default-rtdb.firebaseio.com",
            projectId: "cortex-gold-6c147",
            storageBucket: "cortex-gold-6c147.firebasestorage.app",
            messagingSenderId: "744887943177",
            appId: "1:744887943177:web:c0f4aa606e6e204c7d38d8",
            measurementId: "G-7F8Y8DHZ9H"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect } = React;

        function Dashboard() {
            const [user, setUser] = useState(null);
            const [balance, setBalance] = useState(0);
            const [showFundModal, setShowFundModal] = useState(false);

            useEffect(() => {
                const session = JSON.parse(localStorage.getItem('currentUser'));
                if (!session) {
                    window.location.href = 'index.html';
                } else {
                    setUser(session);
                    // REAL-TIME CLOUD LISTENER
                    const userRef = db.ref(`users/${session.email.replace('.', '_')}/balance`);
                    userRef.on('value', (snapshot) => {
                        setBalance(snapshot.val() || 0);
                    });
                }
            }, []);

            // 2. THE AUTOMATIC PAYSTACK TRIGGER
            const triggerPaystack = () => {
                const amount = prompt("How much Naira do you want to add to your wallet?");
                if (!amount || isNaN(amount) || amount < 100) {
                    alert("Minimum funding is 100 Naira");
                    return;
                }

                const handler = PaystackPop.setup({
                    key: ' pk_test_77e96f0549cd29e76ce2117f8adf00a5a96658ea '// PASTE YOUR PUBLIC KEY HERE
                    email: user.email,
                    amount: amount * 100, // Naira to Kobo
                    currency: "NGN",
                    channels: ['bank_transfer', 'card'],
                    metadata: {
                        custom_fields: [{ display_name: "Email", variable_name: "email", value: user.email }]
                    },
                    callback: function(response) {
                        alert("Transfer detected! Balance will update automatically once bank confirms (approx 1-2 mins).");
                        setShowFundModal(false);
                    },
                    onClose: function() {
                        alert("Transaction cancelled.");
                    }
                });
                handler.openIframe();
            };

            const logout = () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            };

            if (!user) return <div className="p-10 text-center">Loading Cloud...</div>;

            return (
                <div className="min-h-screen">
                    <nav className="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm">
                        <h1 className="text-xl font-black text-blue-600 tracking-tight">CORTEX GOLD</h1>
                        <div className="flex items-center gap-4">
                            <span className="text-sm font-medium bg-gray-100 px-3 py-1 rounded-full">{user.email}</span>
                            <button onClick={logout} className="text-red-500 font-bold text-sm">Logout</button>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto p-6 text-center">
                        <div className="bg-gradient-to-br from-blue-700 to-blue-500 rounded-3xl p-10 text-white shadow-xl">
                            <p className="text-blue-100 font-medium">Cloud Wallet Balance</p>
                            <h2 className="text-6xl font-black mt-2 mb-8">‚Ç¶{balance.toLocaleString()}</h2>
                            <button 
                                onClick={() => setShowFundModal(true)}
                                className="bg-white text-blue-600 px-10 py-4 rounded-2xl font-black shadow-lg hover:scale-105 transition"
                            >
                                + ADD MONEY
                            </button>
                        </div>
                    </main>

                    {/* FUNDING MODAL */}
                    {showFundModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-3xl p-8 w-full max-w-md">
                                <h3 className="text-2xl font-bold mb-6 text-center">Choose Funding Method</h3>
                                <div className="space-y-4">
                                    <button onClick={triggerPaystack} className="w-full p-6 border-2 border-blue-100 rounded-2xl flex items-center hover:bg-blue-50 transition">
                                        <span className="text-3xl mr-4">üè¶</span>
                                        <div className="text-left">
                                            <p className="font-bold">Automatic Bank Transfer</p>
                                            <p className="text-xs text-gray-500">Paystack generates an account for you</p>
                                        </div>
                                    </button>
                                    <button onClick={() => setShowFundModal(false)} className="w-full py-3 text-gray-400 font-medium">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
