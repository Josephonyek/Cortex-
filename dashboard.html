<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cortex Gold | Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const firebaseConfig = {
            apiKey: "AIzaSyAzXdmATMQ8bMAtCIMiruUr4o5lGLMTSco",
            authDomain: "cortex-gold-6c147.firebaseapp.com",
            databaseURL: "https://cortex-gold-6c147-default-rtdb.firebaseio.com",
            projectId: "cortex-gold-6c147",
            storageBucket: "cortex-gold-6c147.firebasestorage.app",
            messagingSenderId: "744887943177",
            appId: "1:744887943177:web:c0f4aa606e6e204c7d38d8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function Dashboard() {
            const [user, setUser] = useState(null);
            const [balance, setBalance] = useState(0);
            const [products, setProducts] = useState([]);

            useEffect(() => {
                const session = JSON.parse(localStorage.getItem('currentUser'));
                if (!session || !session.uid) { window.location.href = 'login.html'; return; }
                setUser(session);

                // REAL-TIME BALANCE SYNC USING UID
                const userRef = db.ref(`users/${session.uid}`);
                userRef.on('value', (snap) => {
                    const data = snap.val();
                    if (data) setBalance(data.balance || 0);
                });

                // SYNC PRODUCTS
                db.ref('products').on('value', (snap) => {
                    const data = snap.val();
                    if (data) setProducts(Object.values(data));
                });
            }, []);

            const fundWallet = () => {
                const amt = prompt("Amount to add (â‚¦):");
                if (!amt || amt < 100) return alert("Min â‚¦100");
                const handler = PaystackPop.setup({
                    key: 'pk_test_77e96f0549cd29e76ce2117f8adf00a5a96658ea',
                    email: user.email,
                    amount: amt * 100,
                    currency: "NGN",
                    callback: (res) => alert("Success! Wallet will update soon.")
                });
                handler.openIframe();
            };

            const buyProduct = (name, price) => {
                if (balance < price) return alert("Insufficient funds!");
                if (confirm(`Buy ${name} for â‚¦${price}?`)) {
                    db.ref(`users/${user.uid}/balance`).transaction(c => (c || 0) - price)
                    .then(() => {
                        window.open(`https://wa.me/2349118363627?text=I bought ${name}`, '_blank');
                    });
                }
            };

            if (!user) return null;

            return (
                <div className="max-w-md mx-auto min-h-screen pb-20">
                    <header className="p-6 flex justify-between items-center">
                        <h1 className="font-black text-2xl text-blue-600">CORTEX GOLD</h1>
                        <button onClick={() => {localStorage.clear(); window.location.href='login.html'}} className="text-[10px] font-bold text-gray-400">LOGOUT</button>
                    </header>
                    <div className="px-6">
                        <div className="bg-blue-600 rounded-[2.5rem] p-8 text-white shadow-xl">
                            <p className="text-xs font-bold opacity-70">WALLET BALANCE</p>
                            <h2 className="text-5xl font-black mt-2 mb-6">â‚¦{balance.toLocaleString()}</h2>
                            <button onClick={fundWallet} className="bg-white text-blue-600 px-8 py-3 rounded-xl font-bold text-sm">+ FUND</button>
                        </div>
                    </div>
                    <div className="p-6">
                        <h3 className="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">Marketplace</h3>
                        <div className="grid grid-cols-2 gap-4">
                            {products.map((p, i) => (
                                <div key={i} onClick={() => buyProduct(p.name, p.price)} className="bg-white p-5 rounded-3xl border shadow-sm active:bg-gray-100 cursor-pointer">
                                    <div className="text-3xl mb-2">{p.icon || 'ðŸ“¦'}</div>
                                    <h4 className="font-bold text-sm truncate">{p.name}</h4>
                                    <p className="text-blue-600 font-black">â‚¦{p.price}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <a href="https://wa.me/2349037416009" target="_blank" className="fixed bottom-6 right-6 bg-green-500 p-4 rounded-full shadow-2xl">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" className="w-8 h-8" alt="Support" />
                    </a>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard />);
    </script>
</body>
</html>