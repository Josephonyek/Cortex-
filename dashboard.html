<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cortex Gold Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // 1. YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAzXdmATMQ8bMAtCIMiruUr4o5lGLMTSco",
            authDomain: "cortex-gold-6c147.firebaseapp.com",
            databaseURL: "https://cortex-gold-6c147-default-rtdb.firebaseio.com",
            projectId: "cortex-gold-6c147",
            storageBucket: "cortex-gold-6c147.firebasestorage.app",
            messagingSenderId: "744887943177",
            appId: "1:744887943177:web:c0f4aa606e6e204c7d38d8",
            measurementId: "G-7F8Y8DHZ9H"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect } = React;

        function Dashboard() {
            const [user, setUser] = useState(null);
            const [balance, setBalance] = useState(0);
            const [showFundModal, setShowFundModal] = useState(false);
            const [fundMethod, setFundMethod] = useState(null); 
            const [customerList, setCustomerList] = useState([]);

            useEffect(() => {
                const session = JSON.parse(localStorage.getItem('currentUser'));
                if (!session) {
                    window.location.href = 'index.html';
                } else {
                    setUser(session);
                    
                    // 2. CLOUD SYNC: Listen for real-time balance changes
                    const userBalanceRef = db.ref(`users/${session.email.replace('.', '_')}/balance`);
                    userBalanceRef.on('value', (snapshot) => {
                        const cloudBalance = snapshot.val();
                        setBalance(cloudBalance || 0);
                    });
                }

                // 3. ADMIN: Load all customers from Cloud
                if (session?.role === 'admin') {
                    db.ref('users').on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const list = Object.keys(data).map(key => data[key]);
                            setCustomerList(list);
                        }
                    });
                }
            }, []);

            const handlePaymentComplete = (amount) => {
                if (!amount || isNaN(amount)) return;
                const newBal = balance + parseFloat(amount);
                
                // 4. SAVE TO CLOUD (Replaces localStorage)
                const userKey = user.email.replace('.', '_');
                db.ref(`users/${userKey}`).update({
                    balance: newBal,
                    email: user.email,
                    name: user.name || "Customer"
                });
                
                alert(`Successfully funded $${amount}!`);
                setFundMethod(null);
                setShowFundModal(false);
            };

            const logout = () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            };

            if (!user) return <div className="p-10 text-center">Loading Cloud...</div>;

            return (
                <div className="min-h-screen">
                    {/* TOP NAVIGATION */}
                    <nav className="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm">
                        <h1 className="text-xl font-black text-blue-600 tracking-tight">CORTEX GOLD</h1>
                        <div className="flex items-center gap-4">
                            <span className="text-sm font-medium bg-gray-100 px-3 py-1 rounded-full">{user.email}</span>
                            <button onClick={logout} className="text-red-500 font-bold text-sm">Logout</button>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto p-6">
                        {user.role === 'admin' ? (
                            /* ADMIN VIEW */
                            <div className="space-y-6">
                                <h2 className="text-3xl font-bold">Admin Management</h2>
                                <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 border-b">
                                            <tr>
                                                <th className="p-4 font-semibold text-gray-600">Customer</th>
                                                <th className="p-4 font-semibold text-gray-600">Email</th>
                                                <th className="p-4 font-semibold text-gray-600">Wallet Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {customerList.map(cust => (
                                                <tr key={cust.email} className="border-b last:border-none">
                                                    <td className="p-4">{cust.name}</td>
                                                    <td className="p-4 text-gray-500">{cust.email}</td>
                                                    <td className="p-4 font-bold text-green-600">${parseFloat(cust.balance || 0).toFixed(2)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            /* CUSTOMER VIEW */
                            <div className="space-y-8">
                                <div className="bg-gradient-to-br from-blue-700 to-blue-500 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-blue-100 font-medium">Your Wallet Balance</p>
                                        <h2 className="text-5xl font-black mt-2 mb-6">${balance.toFixed(2)}</h2>
                                        <button 
                                            onClick={() => setShowFundModal(true)}
                                            className="bg-white text-blue-600 px-8 py-3 rounded-xl font-bold hover:bg-blue-50 transition transform hover:scale-105"
                                        >
                                            + Fund Wallet
                                        </button>
                                    </div>
                                </div>

                                <h3 className="text-2xl font-bold">Available Products</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-white p-6 rounded-2xl border shadow-sm flex justify-between items-center">
                                        <div>
                                            <h4 className="font-bold text-lg">Premium Socks Pack</h4>
                                            <p className="text-blue-600 font-bold">$12.00</p>
                                        </div>
                                        <button className="bg-gray-900 text-white px-6 py-2 rounded-lg font-bold">Order Now</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* FUNDING MODAL */}
                    {showFundModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold">Fund Wallet</h3>
                                    <button onClick={() => {setShowFundModal(false); setFundMethod(null);}} className="text-gray-400 text-2xl">‚úï</button>
                                </div>

                                {!fundMethod ? (
                                    <div className="grid grid-cols-1 gap-4">
                                        <button onClick={() => setFundMethod('card')} className="w-full p-5 border-2 rounded-2xl flex items-center hover:border-blue-500 hover:bg-blue-50 transition">
                                            <span className="text-3xl mr-4">üí≥</span>
                                            <div className="text-left">
                                                <p className="font-bold">Debit/Credit Card</p>
                                                <p className="text-xs text-gray-500">Instant funding via card</p>
                                            </div>
                                        </button>
                                        <button onClick={() => setFundMethod('transfer')} className="w-full p-5 border-2 rounded-2xl flex items-center hover:border-blue-500 hover:bg-blue-50 transition">
                                            <span className="text-3xl mr-4">üè¶</span>
                                            <div className="text-left">
                                                <p className="font-bold">Bank Transfer</p>
                                                <p className="text-xs text-gray-500">Direct deposit to bank</p>
                                            </div>
                                        </button>
                                    </div>
                                ) : fundMethod === 'card' ? (
                                    <form onSubmit={(e) => { e.preventDefault(); handlePaymentComplete(e.target.amount.value); }} className="space-y-4">
                                        <input type="number" name="amount" placeholder="Enter Amount ($)" className="w-full p-4 border rounded-xl" required />
                                        <input type="text" placeholder="Card Number" className="w-full p-4 border rounded-xl" />
                                        <div className="flex gap-4">
                                            <input type="text" placeholder="MM/YY" className="w-1/2 p-4 border rounded-xl" />
                                            <input type="text" placeholder="CVV" className="w-1/2 p-4 border rounded-xl" />
                                        </div>
                                        <button type="submit" className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Pay Now</button>
                                    </form>
                                ) : (
                                    <div className="space-y-6">
                                        <div className="bg-blue-50 p-6 rounded-2xl border-2 border-dashed border-blue-200">
                                            <p className="text-xs text-blue-600 uppercase font-bold mb-2">Transfer to Account Below</p>
                                            <p className="text-sm text-gray-500">Bank Name</p>
                                            <p className="font-bold">Business Global Bank</p>
                                            <p className="text-sm text-gray-500 mt-2">Account Number</p>
                                            <p className="font-black text-2xl text-blue-700 tracking-wider">0123456789</p>
                                        </div>
                                        <button onClick={() => handlePaymentComplete(prompt("How much did you transfer?"))} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold">Notify Admin of Transfer</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
